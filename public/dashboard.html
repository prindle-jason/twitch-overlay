<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Overlay Dashboard</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        padding: 1rem;
        max-width: 600px;
        margin: 0 auto;
      }
      h1 {
        margin-top: 0;
      }
      .info {
        background: #f0f0f0;
        padding: 1rem;
        border-radius: 4px;
      }
      button {
        padding: 0.5rem 1rem;
        margin-top: 1rem;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Overlay Dashboard</h1>
    <div class="info">
      <p>Connected: <strong id="status">Connecting...</strong></p>
    </div>
    <button id="testBtn">Send Test Event</button>
    <button id="statsBtn">Get Stats</button>
    <button id="bamSuccessBtn">Spawn Bam Success</button>
    <button id="bamUhOhBtn">Spawn Bam UhOh</button>
    <button id="ssbmSuccessBtn">Spawn SSBM Success</button>
    <button id="ssbmFailBtn">Spawn SSBM Fail</button>
    <button id="headbladeBtn">Spawn Headblade</button>
    <div
      id="log"
      style="
        margin-top: 1rem;
        white-space: pre-wrap;
        background: #fafafa;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      "
    ></div>
    <script>
      const statusEl = document.getElementById("status");
      const logEl = document.getElementById("log");
      const testBtn = document.getElementById("testBtn");
      const statsBtn = document.getElementById("statsBtn");
      const bamSuccessBtn = document.getElementById("bamSuccessBtn");
      const bamUhOhBtn = document.getElementById("bamUhOhBtn");
      const ssbmSuccessBtn = document.getElementById("ssbmSuccessBtn");
      const ssbmFailBtn = document.getElementById("ssbmFailBtn");
      const headbladeBtn = document.getElementById("headbladeBtn");

      const allButtons = [
        testBtn,
        statsBtn,
        bamSuccessBtn,
        bamUhOhBtn,
        ssbmSuccessBtn,
        ssbmFailBtn,
        headbladeBtn,
      ].filter(Boolean);

      function log(msg) {
        logEl.textContent += new Date().toLocaleTimeString() + " " + msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
      }

      function setConnected(connected) {
        statusEl.textContent = connected ? "Connected" : "Disconnected";
        statusEl.style.color = connected ? "green" : "red";
        allButtons.forEach((b) => (b.disabled = !connected));
      }

      let ws = null;
      let reconnectDelay = 500;
      const maxDelay = 10000;

      function send(type, payload) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          log("Cannot send; WS not connected");
          return;
        }
        const msg = payload
          ? { type, role: "dashboard", payload }
          : { type, role: "dashboard" };
        ws.send(JSON.stringify(msg));
      }

      function spawn(effectType) {
        send("spawn-effect", { effectType });
      }

      function connect() {
        ws = new WebSocket("ws://" + window.location.host + "/overlay-ws");
        ws.onopen = () => {
          setConnected(true);
          reconnectDelay = 500;
          send("hello");
          log("WS connected");
        };
        ws.onmessage = (e) => {
          try {
            const msg = JSON.parse(e.data);
            log("Received: " + msg.type);
          } catch (err) {
            log("Parse error: " + err.message);
          }
        };
        ws.onclose = () => {
          setConnected(false);
          log("WS closed; reconnecting in " + reconnectDelay + "ms");
          setTimeout(connect, reconnectDelay);
          reconnectDelay = Math.min(maxDelay, reconnectDelay * 2);
        };
        ws.onerror = () => {
          log("WS error");
        };
      }

      // Hook up buttons via helpers
      testBtn.addEventListener("click", () => send("ping"));
      statsBtn.addEventListener("click", () => send("get-stats"));
      bamSuccessBtn.addEventListener("click", () => spawn("bamSuccess"));
      bamUhOhBtn.addEventListener("click", () => spawn("bamUhOh"));
      ssbmSuccessBtn.addEventListener("click", () => spawn("ssbmSuccess"));
      ssbmFailBtn.addEventListener("click", () => spawn("ssbmFail"));
      headbladeBtn.addEventListener("click", () => spawn("headblade"));

      // Heartbeat ping
      setInterval(() => send("ping"), 30000);

      // Start disconnected until first open
      setConnected(false);
      connect();
    </script>
  </body>
</html>
